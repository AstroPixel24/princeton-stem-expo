<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Payment System Test</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 40px; }
        .test-section { margin: 20px 0; padding: 20px; border: 1px solid #ddd; border-radius: 8px; }
        .success { background: #d4edda; border-color: #c3e6cb; }
        .error { background: #f8d7da; border-color: #f5c6cb; }
        .info { background: #d1ecf1; border-color: #bee5eb; }
        button { padding: 10px 20px; margin: 10px 0; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; }
        pre { background: #f8f9fa; padding: 10px; border-radius: 4px; overflow-x: auto; }
    </style>
</head>
<body>
    <h1>Princeton STEM Expo - Payment System Test</h1>
    
    <div class="test-section info">
        <h2>Instructions</h2>
        <p>This page will help diagnose issues with your Google Apps Script payment setup.</p>
        <ol>
            <li>Click "Test Google Apps Script" to check if your script is responding</li>
            <li>Check the results below for specific error messages</li>
            <li>Follow the troubleshooting steps based on the results</li>
        </ol>
    </div>

    <div class="test-section">
        <h2>Google Apps Script Test</h2>
        <button onclick="testGoogleAppsScript()">Test Google Apps Script</button>
        <div id="gas-results"></div>
    </div>

    <div class="test-section">
        <h2>Configuration Check</h2>
        <button onclick="showConfiguration()">Show Current Configuration</button>
        <div id="config-results"></div>
    </div>

    <script>
        // Replace this with your Google Apps Script URL
        const scriptURL = 'https://script.google.com/macros/s/AKfycbyW4RoGyn6Ccgd0jRBfKvWUflkxqKSoeH95tJfc0OqOmfQZm369UE4Wsn-gYzCF5sp4/exec';
        
        async function testGoogleAppsScript() {
            const resultsDiv = document.getElementById('gas-results');
            resultsDiv.innerHTML = '<p>Testing Google Apps Script...</p>';
            
            try {
                console.log('üß™ Testing Google Apps Script...');
                console.log('üì° URL:', scriptURL);
                
                const response = await fetch(scriptURL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: new URLSearchParams({
                        action: 'createPaymentIntent',
                        amount: '2500',
                        currency: 'usd'
                    })
                });

                console.log('üì° Response status:', response.status);
                console.log('üì° Response ok:', response.ok);

                const responseText = await response.text();
                console.log('üì° Raw response:', responseText);

                let result;
                try {
                    result = JSON.parse(responseText);
                } catch (parseError) {
                    throw new Error('Invalid JSON response: ' + responseText);
                }

                console.log('üì° Parsed result:', result);

                if (result.error) {
                    resultsDiv.innerHTML = `
                        <div class="error">
                            <h3>‚ùå Google Apps Script Error</h3>
                            <p><strong>Error:</strong> ${result.error}</p>
                            ${result.detail ? `<p><strong>Details:</strong> ${result.detail}</p>` : ''}
                            <h4>Troubleshooting:</h4>
                            <ul>
                                <li>Check that STRIPE_SECRET is set in Google Apps Script ‚Üí Project Settings ‚Üí Script Properties</li>
                                <li>Verify your Stripe secret key starts with 'sk_test_' or 'sk_live_'</li>
                                <li>Make sure the Google Apps Script Code.gs file contains the correct code</li>
                            </ul>
                        </div>
                    `;
                } else if (result.clientSecret && result.paymentIntentId) {
                    resultsDiv.innerHTML = `
                        <div class="success">
                            <h3>‚úÖ Google Apps Script Working!</h3>
                            <p><strong>PaymentIntent ID:</strong> ${result.paymentIntentId}</p>
                            <p><strong>Client Secret:</strong> ${result.clientSecret.substring(0, 20)}...</p>
                            <p>Your Google Apps Script is correctly configured and communicating with Stripe!</p>
                        </div>
                    `;
                } else {
                    resultsDiv.innerHTML = `
                        <div class="error">
                            <h3>‚ùå Incomplete Response</h3>
                            <p>Google Apps Script responded but didn't return the expected data.</p>
                            <pre>${JSON.stringify(result, null, 2)}</pre>
                            <h4>Troubleshooting:</h4>
                            <ul>
                                <li>Check that your Google Apps Script Code.gs file has the correct code</li>
                                <li>Verify the script is deployed as a Web App with correct permissions</li>
                            </ul>
                        </div>
                    `;
                }

            } catch (error) {
                console.error('‚ùå Test error:', error);
                
                let errorMsg = error.message;
                let troubleshooting = [];
                
                if (error.message.includes('Failed to fetch') || error.message.includes('NetworkError')) {
                    errorMsg = 'Network error - cannot reach Google Apps Script';
                    troubleshooting = [
                        'Check your internet connection',
                        'Verify the Google Apps Script URL is correct',
                        'Make sure the script is deployed as a Web App'
                    ];
                } else if (error.message.includes('CORS')) {
                    errorMsg = 'CORS error - script deployment issue';
                    troubleshooting = [
                        'Redeploy your Google Apps Script as a Web App',
                        'Make sure "Who has access" is set to "Anyone"',
                        'Try creating a new deployment'
                    ];
                } else if (error.message.includes('Invalid JSON')) {
                    errorMsg = 'Script returned invalid response';
                    troubleshooting = [
                        'Check that your Code.gs file has the correct code',
                        'Look for syntax errors in your Google Apps Script',
                        'Check the Apps Script execution log for errors'
                    ];
                }
                
                resultsDiv.innerHTML = `
                    <div class="error">
                        <h3>‚ùå Test Failed</h3>
                        <p><strong>Error:</strong> ${errorMsg}</p>
                        <h4>Troubleshooting:</h4>
                        <ul>
                            ${troubleshooting.map(item => `<li>${item}</li>`).join('')}
                        </ul>
                        <h4>Raw Error:</h4>
                        <pre>${error.message}</pre>
                    </div>
                `;
            }
        }

        function showConfiguration() {
            const configDiv = document.getElementById('config-results');
            configDiv.innerHTML = `
                <div class="info">
                    <h3>Current Configuration</h3>
                    <p><strong>Google Apps Script URL:</strong></p>
                    <pre>${scriptURL}</pre>
                    
                    <h4>Required Setup in Google Apps Script:</h4>
                    <ol>
                        <li><strong>Code.gs file:</strong> Must contain the PaymentIntent creation code</li>
                        <li><strong>Script Properties:</strong> Must have STRIPE_SECRET set</li>
                        <li><strong>Deployment:</strong> Must be deployed as Web App with "Anyone" access</li>
                    </ol>
                    
                    <h4>How to check Google Apps Script setup:</h4>
                    <ol>
                        <li>Go to <a href="https://script.google.com" target="_blank">script.google.com</a></li>
                        <li>Open your project</li>
                        <li>Go to <strong>Project Settings</strong> ‚Üí <strong>Script Properties</strong></li>
                        <li>Verify STRIPE_SECRET is listed and has a value starting with 'sk_'</li>
                        <li>Go to <strong>Deploy</strong> ‚Üí <strong>Manage Deployments</strong></li>
                        <li>Verify you have a Web App deployment with "Execute as: Me" and "Who has access: Anyone"</li>
                    </ol>
                </div>
            `;
        }
    </script>
</body>
</html>